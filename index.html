<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>QRã‚³ãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸é€£å‹•PDFãƒ“ãƒ¥ãƒ¼ã‚¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

  <!-- jsQRï¼ˆQRã‚³ãƒ¼ãƒ‰è§£æï¼‰ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.min.js"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui;
      background: #f5f5f5;
      padding: 10px;
      color: #222;
    }
    h1 {
      text-align: center;
      font-size: 1.2rem;
      margin-bottom: 10px;
    }
    .section {
      background: #fff;
      padding: 10px;
      margin-bottom: 14px;
      border-radius: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    #pdf-canvas { width: 100%; background: #888; border-radius: 8px; }
    #video { width: 100%; border-radius: 8px; background: #000; }
    button {
      padding: 6px 14px;
      border-radius: 999px;
      border: none;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .primary { background: #007bff; color: #fff; }
    .danger { background: #d9534f; color: #fff; }
    .disabled { opacity: .5; pointer-events: none; }
    .row { display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; }
  </style>
</head>
<body>

<h1>ğŸ“˜ QRã‚³ãƒ¼ãƒ‰é€£å‹• PDFãƒ“ãƒ¥ãƒ¼ã‚¢</h1>

<!-- PDF ãƒ­ãƒ¼ãƒ‰ -->
<div class="section">
  <h2>â‘  PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€</h2>
  <div class="row">
    <input type="file" id="file-input" accept="application/pdf" />
  </div>
  <div class="row">
    <input id="url-input" type="text" placeholder="PDFã®URLï¼ˆhttps://...pdfï¼‰" style="flex:1;padding:6px;">
    <button class="primary" id="load-url-btn">URLèª­è¾¼</button>
  </div>

  <div id="pdf-info" style="font-size:0.85rem;color:#555;">PDFæœªèª­è¾¼</div>

  <canvas id="pdf-canvas"></canvas>

  <div class="row" style="margin-top:8px;">
    <button id="prev-btn">å‰ã¸</button>
    <div id="page-num" style="min-width:90px;text-align:center;">0 / 0</div>
    <button id="next-btn">æ¬¡ã¸</button>
  </div>
</div>

<!-- QR ã‚«ãƒ¡ãƒ© -->
<div class="section">
  <h2>â‘¡ QRã‚³ãƒ¼ãƒ‰ã§ãƒšãƒ¼ã‚¸ç§»å‹•</h2>

  <div class="row">
    <button id="toggle-camera" class="primary">ã‚«ãƒ¡ãƒ©èµ·å‹•</button>
  </div>

  <video id="video" autoplay playsinline muted></video>

  <canvas id="qr-canvas" style="display:none;"></canvas>

  <div id="qr-log" style="font-size:0.85rem;margin-top:6px;">çŠ¶æ…‹ï¼šã‚«ãƒ¡ãƒ©åœæ­¢ä¸­</div>
</div>

<script>
/* ======================= PDF.js è¨­å®š ======================= */
const pdfjsLib = window["pdfjsLib"];
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

let pdfDoc = null;
let currentPage = 1;
let totalPages = 0;

const pdfCanvas = document.getElementById("pdf-canvas");
const pdfCtx = pdfCanvas.getContext("2d");

async function renderPage(num) {
  if (!pdfDoc) return;
  const page = await pdfDoc.getPage(num);
  const viewport = page.getViewport({ scale: 1.4 });

  pdfCanvas.width = viewport.width;
  pdfCanvas.height = viewport.height;

  await page.render({ canvasContext: pdfCtx, viewport }).promise;

  currentPage = num;
  document.getElementById("page-num").textContent =
    `${currentPage} / ${totalPages}`;
}

async function loadPdfFromFile(file) {
  const reader = new FileReader();
  reader.onload = async function(ev) {
    const data = ev.target.result;
    const task = pdfjsLib.getDocument({ data });
    pdfDoc = await task.promise;
    totalPages = pdfDoc.numPages;
    document.getElementById("pdf-info").textContent =
      `${file.name} | ${totalPages}ãƒšãƒ¼ã‚¸`;
    renderPage(1);
  };
  reader.readAsArrayBuffer(file);
}

async function loadPdfFromUrl(url) {
  try {
    const task = pdfjsLib.getDocument({ url });
    pdfDoc = await task.promise;
    totalPages = pdfDoc.numPages;
    document.getElementById("pdf-info").textContent =
      `${url} | ${totalPages}ãƒšãƒ¼ã‚¸`;
    renderPage(1);
  } catch (e) {
    alert("URL èª­è¾¼å¤±æ•—");
  }
}

document.getElementById("file-input").addEventListener("change", e => {
  if (e.target.files[0]) loadPdfFromFile(e.target.files[0]);
});

document.getElementById("load-url-btn").addEventListener("click", () => {
  const url = document.getElementById("url-input").value.trim();
  if (url) loadPdfFromUrl(url);
});

document.getElementById("prev-btn").addEventListener("click", () => {
  if (currentPage > 1) renderPage(currentPage - 1);
});
document.getElementById("next-btn").addEventListener("click", () => {
  if (currentPage < totalPages) renderPage(currentPage + 1);
});

/* ======================= QR ã‚¹ã‚­ãƒ£ãƒ³ ======================= */
let cameraOn = false;
let stream = null;

const video = document.getElementById("video");
const qrCanvas = document.getElementById("qr-canvas");
const qrCtx = qrCanvas.getContext("2d");
const qrLog = document.getElementById("qr-log");

let lastScan = "";
let lastTime = 0;

async function startCamera() {
  stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "environment" }
  });
  video.srcObject = stream;
  cameraOn = true;
  document.getElementById("toggle-camera").textContent = "ã‚«ãƒ¡ãƒ©åœæ­¢";
  qrLog.textContent = "çŠ¶æ…‹ï¼šã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­";
  scanLoop();
}

function stopCamera() {
  if (stream) stream.getTracks().forEach(t => t.stop());
  cameraOn = false;
  video.srcObject = null;
  document.getElementById("toggle-camera").textContent = "ã‚«ãƒ¡ãƒ©èµ·å‹•";
  qrLog.textContent = "çŠ¶æ…‹ï¼šã‚«ãƒ¡ãƒ©åœæ­¢ä¸­";
}

document.getElementById("toggle-camera").addEventListener("click", () => {
  if (cameraOn) stopCamera();
  else startCamera();
});

function scanLoop() {
  if (!cameraOn) return;

  const vw = video.videoWidth;
  const vh = video.videoHeight;

  if (vw === 0) {
    requestAnimationFrame(scanLoop);
    return;
  }

  qrCanvas.width = vw;
  qrCanvas.height = vh;
  qrCtx.drawImage(video, 0, 0, vw, vh);

  const imgData = qrCtx.getImageData(0, 0, vw, vh);

  const code = jsQR(imgData.data, vw, vh);

  if (code) {
    const now = Date.now();

    if (code.data !== lastScan || now - lastTime > 1500) {
      lastScan = code.data;
      lastTime = now;

      qrLog.textContent = "QRæ¤œå‡ºï¼š" + code.data;

      const pageNum = parseInt(code.data, 10);
      if (Number.isInteger(pageNum) && pageNum >= 1 && pageNum <= totalPages) {
        renderPage(pageNum);
      }
    }
  }

  requestAnimationFrame(scanLoop);
}
</script>
</body>
</html>
