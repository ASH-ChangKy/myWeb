<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ãƒšãƒ¼ã‚¸ç•ªå·åŒæœŸ PDF ãƒªãƒ¼ãƒ€ãƒ¼ï¼ˆã‚«ãƒ¡ãƒ©é€£å‹•ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PDF.js 2.16.105 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

  <!-- Tesseract.js -->
  <script src="https://unpkg.com/tesseract.js@5.0.2/dist/tesseract.min.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui;
      background: #f4f4f4;
      color: #222;
      padding: 10px;
    }
    h1 {
      font-size: 1.1rem;
      text-align: center;
      margin-bottom: 8px;
    }
    .top-bar {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-bottom: 8px;
    }
    .section {
      background: #fff;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }
    .section-title {
      font-size: 0.95rem;
      margin-bottom: 6px;
      font-weight: 600;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    input[type="file"],
    input[type="text"] {
      font-size: 0.85rem;
    }
    input[type="text"] {
      flex: 1;
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 0.85rem;
      cursor: pointer;
      white-space: nowrap;
    }
    button.primary { background: #007bff; color: #fff; }
    button.danger  { background: #dc3545; color: #fff; }
    button.secondary { background: #6c757d; color: #fff; }
    button:disabled { opacity: 0.5; cursor: default; }

    #pdf-info { font-size: 0.8rem; margin-top: 4px; }

    #pdf-container {
      background: #333;
      border-radius: 8px;
      overflow: hidden;
      margin-top: 6px;
      text-align: center;
      max-height: 75vh;
    }
    #pdf-canvas {
      width: 100%;
      height: auto;
      display: block;
      background: #777;
    }

    #page-controls {
      margin-top: 6px;
      display: flex;
      justify-content: center;
      gap: 10px;
      font-size: 0.85rem;
      align-items: center;
      flex-wrap: wrap;
    }
    #page-indicator { min-width: 100px; text-align: center; }

    #camera-view {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      background: #000;
      max-height: 260px;
      margin-top: 6px;
    }
    #video {
      width: 100%;
      height: auto;
      display: block;
    }

    #ocr-log {
      font-size: 0.8rem;
      margin-top: 6px;
      min-height: 3em;
    }

    .hint {
      font-size: 0.75rem;
      color: #666;
      margin-top: 4px;
      line-height: 1.4;
    }

    /* èª­æ›¸ãƒ¢ãƒ¼ãƒ‰ï¼ˆãªã‚“ã¡ã‚ƒã£ã¦å…¨ç”»é¢ï¼‰ */
    body.reading-mode {
      padding: 0;
      background: #000;
      color: #eee;
    }
    body.reading-mode h1,
    body.reading-mode .camera-section,
    body.reading-mode .pdf-load-controls {
      display: none;
    }
    body.reading-mode .pdf-section {
      margin: 0;
      border-radius: 0;
      box-shadow: none;
    }
    body.reading-mode #pdf-container {
      border-radius: 0;
      max-height: 100vh;
      height: 100vh;
    }
    body.reading-mode #page-controls {
      position: fixed;
      bottom: 8px;
      left: 0;
      right: 0;
      justify-content: center;
      z-index: 10;
    }
  </style>
</head>

<body>
  <h1>ğŸ“˜ ã‚«ãƒ¡ãƒ©ã§ç´™ã®ãƒšãƒ¼ã‚¸ç•ªå·ã‚’èª­ã¿å–ã‚Š â†’ PDF ã‚’è‡ªå‹•åŒæœŸ</h1>

  <div class="top-bar">
    <button class="secondary" id="reading-mode-btn">èª­æ›¸ãƒ¢ãƒ¼ãƒ‰ã«ã™ã‚‹</button>
  </div>

  <!-- PDF èª­ã¿è¾¼ã¿ & è¡¨ç¤º -->
  <div class="section pdf-section">
    <div class="pdf-load-controls">
      <div class="section-title">1ï¸âƒ£ PDF ã‚’èª­ã¿è¾¼ã‚€</div>
      <div class="row" style="margin-bottom:6px;">
        <label style="font-size:0.85rem;">
          ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰:
          <input type="file" id="file-input" accept="application/pdf" />
        </label>
      </div>
      <div class="row">
        <input
          type="text"
          id="url-input"
          placeholder="ã¾ãŸã¯ PDF ã® URLï¼ˆhttps://...pdfï¼‰"
        />
        <button class="primary" id="load-url-btn">URL èª­ã¿è¾¼ã¿</button>
      </div>
      <div id="pdf-info">ã¾ã  PDF ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“</div>
    </div>

    <div id="pdf-container">
      <canvas id="pdf-canvas"></canvas>
    </div>

    <div id="page-controls">
      <button id="prev-page-btn">å‰ã®ãƒšãƒ¼ã‚¸</button>
      <div id="page-indicator">ãƒšãƒ¼ã‚¸ 0 / 0</div>
      <button id="next-page-btn">æ¬¡ã®ãƒšãƒ¼ã‚¸</button>
    </div>
  </div>

  <!-- ã‚«ãƒ¡ãƒ© + ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ  OCR -->
  <div class="section camera-section">
    <div class="section-title">2ï¸âƒ£ ã‚«ãƒ¡ãƒ©ã§ç´™ã®ãƒšãƒ¼ã‚¸ç•ªå·ã‚’èª­ã¿å–ã‚‹ï¼ˆè‡ªå‹•ãƒšãƒ¼ã‚¸ã‚ãã‚Šï¼‰</div>
    <button class="primary" id="toggle-camera-btn">ã‚«ãƒ¡ãƒ©ã‚’ã‚ªãƒ³ã«ã™ã‚‹</button>

    <div id="camera-view">
      <video id="video" autoplay playsinline muted></video>
    </div>

    <div id="ocr-log">çŠ¶æ…‹ï¼šã‚«ãƒ¡ãƒ©ã¯ã‚ªãƒ•ã§ã™</div>
    <div class="hint">
      ä½¿ã„æ–¹ï¼š
      <br>ãƒ»ç´™ã®æœ¬ã®ãƒšãƒ¼ã‚¸ã®è¿‘ãã«å¤§ããæ•°å­—ã‚’æ›¸ã„ã¦ãã ã•ã„ï¼ˆä¾‹ï¼š12, 23, 145ï¼‰
      <br>ãƒ»ã‚¹ãƒãƒ›ã®ã‚«ãƒ¡ãƒ©ã§æ•°å­—ãŒç”»é¢ä¸­å¤®ã«æ¥ã‚‹ã‚ˆã†ã«ã‹ã–ã—ã¾ã™
      <br>ãƒ»åŒã˜æ•°å­—ãŒé€£ç¶šã§èªè­˜ã•ã‚ŒãŸå ´åˆã€PDF ãŒãã®ãƒšãƒ¼ã‚¸ã«è‡ªå‹•ã‚¸ãƒ£ãƒ³ãƒ—ã—ã¾ã™
      <br>ãƒ»ã‚«ãƒ¡ãƒ© ON ä¸­ã¯ã€Œå‰ / æ¬¡ã€ãƒœã‚¿ãƒ³ã¯ç„¡åŠ¹ã«ãªã‚Šã¾ã™
    </div>
  </div>

  <!-- OCR ç”¨ã®éš ã—ã‚­ãƒ£ãƒ³ãƒã‚¹ -->
  <canvas id="capture-canvas" style="display:none;"></canvas>

  <script>
    // ===== PDF.js åˆæœŸåŒ– =====
    var pdfjsLib = window["pdfjsLib"];
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
    pdfjsLib.disableWorker = true; // iOS Safari å¯¾ç­–

    var pdfDoc = null;
    var currentPage = 1;
    var totalPages = 0;

    var pdfCanvas = document.getElementById("pdf-canvas");
    var pdfCtx = pdfCanvas.getContext("2d");
    var pdfInfoEl = document.getElementById("pdf-info");
    var pageIndicatorEl = document.getElementById("page-indicator");
    var prevBtn = document.getElementById("prev-page-btn");
    var nextBtn = document.getElementById("next-page-btn");

    function updatePageIndicator() {
      var text = "ãƒšãƒ¼ã‚¸ " + (totalPages ? currentPage : 0) + " / " + (totalPages || 0);
      pageIndicatorEl.textContent = text;
    }

    function renderPage(pageNum) {
      if (!pdfDoc) return;
      pdfDoc.getPage(pageNum).then(function(page) {
        var viewport = page.getViewport({ scale: 1.4 });
        pdfCanvas.width = viewport.width;
        pdfCanvas.height = viewport.height;
        var renderCtx = { canvasContext: pdfCtx, viewport: viewport };
        page.render(renderCtx).promise.then(function() {
          currentPage = pageNum;
          updatePageIndicator();
        });
      }).catch(function(err) {
        console.error("Render page error:", err);
      });
    }

    function jumpToPage(pageNum) {
      if (!pdfDoc) return;
      if (pageNum < 1 || pageNum > totalPages) return;
      renderPage(pageNum);
    }

    function loadPdfFromData(data, label) {
      var loadingTask = pdfjsLib.getDocument({ data: data });
      loadingTask.promise.then(function(doc) {
        pdfDoc = doc;
        totalPages = pdfDoc.numPages;
        currentPage = 1;
        pdfInfoEl.textContent = label + " | å…¨ " + totalPages + " ãƒšãƒ¼ã‚¸";
        renderPage(1);
      }).catch(function(e) {
        console.error(e);
        alert("PDF ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      });
    }

    function loadPdfFromUrl(url) {
      if (!url) {
        alert("PDF ã® URL ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      var loadingTask = pdfjsLib.getDocument({ url: url });
      loadingTask.promise.then(function(doc) {
        pdfDoc = doc;
        totalPages = pdfDoc.numPages;
        currentPage = 1;
        pdfInfoEl.textContent = url + " | å…¨ " + totalPages + " ãƒšãƒ¼ã‚¸";
        renderPage(1);
      }).catch(function(e) {
        console.error(e);
        alert("URL ã‹ã‚‰ PDF ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚CORS åˆ¶é™ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
      });
    }

    document.getElementById("file-input").addEventListener("change", function(e) {
      var file = e.target.files[0];
      if (!file) return;
      var reader = new FileReader();
      reader.onload = function(ev) {
        loadPdfFromData(ev.target.result, file.name);
      };
      reader.readAsArrayBuffer(file);
    });

    document.getElementById("load-url-btn").addEventListener("click", function() {
      var url = document.getElementById("url-input").value.trim();
      loadPdfFromUrl(url);
    });

    prevBtn.addEventListener("click", function() {
      if (cameraOn) {
        alert("ã‚«ãƒ¡ãƒ© ON ä¸­ã¯æ‰‹å‹•ãƒšãƒ¼ã‚¸ã‚ãã‚Šã¯ä½¿ãˆã¾ã›ã‚“ã€‚");
        return;
      }
      if (!pdfDoc || currentPage <= 1) return;
      renderPage(currentPage - 1);
    });

    nextBtn.addEventListener("click", function() {
      if (cameraOn) {
        alert("ã‚«ãƒ¡ãƒ© ON ä¸­ã¯æ‰‹å‹•ãƒšãƒ¼ã‚¸ã‚ãã‚Šã¯ä½¿ãˆã¾ã›ã‚“ã€‚");
        return;
      }
      if (!pdfDoc || currentPage >= totalPages) return;
      renderPage(currentPage + 1);
    });

    // ===== èª­æ›¸ãƒ¢ãƒ¼ãƒ‰ =====
    var readingModeBtn = document.getElementById("reading-mode-btn");
    var isReadingMode = false;

    function enterReadingMode() {
      document.body.classList.add("reading-mode");
      readingModeBtn.textContent = "èª­æ›¸ãƒ¢ãƒ¼ãƒ‰ã‚’è§£é™¤";
    }

    function exitReadingMode() {
      document.body.classList.remove("reading-mode");
      readingModeBtn.textContent = "èª­æ›¸ãƒ¢ãƒ¼ãƒ‰ã«ã™ã‚‹";
    }

    readingModeBtn.addEventListener("click", function() {
      isReadingMode = !isReadingMode;
      if (isReadingMode) {
        if (cameraOn) stopCamera();
        enterReadingMode();
      } else {
        exitReadingMode();
      }
    });

    // ===== ã‚«ãƒ¡ãƒ© & OCR =====
    var videoEl = document.getElementById("video");
    var captureCanvas = document.getElementById("capture-canvas");
    var captureCtx = captureCanvas.getContext("2d");
    var toggleCameraBtn = document.getElementById("toggle-camera-btn");
    var ocrLog = document.getElementById("ocr-log");

    var cameraOn = false;
    var mediaStream = null;
    var ocrTimer = null;
    var lastPageByOcr = null;
    var ocrRunning = false;

    function startCamera() {
      if (cameraOn) return;

      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã‚«ãƒ¡ãƒ© API ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
        return;
      }
      if (!pdfDoc) {
        alert("ã¾ãš PDF ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚");
        return;
      }

      navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: "environment" } },
        audio: false
      }).then(function(stream) {
        mediaStream = stream;
        videoEl.srcObject = stream;
        cameraOn = true;
        toggleCameraBtn.textContent = "ã‚«ãƒ¡ãƒ©ã‚’ã‚ªãƒ•ã«ã™ã‚‹";
        toggleCameraBtn.classList.add("danger");
        ocrLog.innerHTML = "çŠ¶æ…‹ï¼šã‚«ãƒ¡ãƒ© ONã€‚æ•°å­—ã‚’ç”»é¢ä¸­å¤®ã«å…¥ã‚Œã¦ãã ã•ã„ã€‚";

        prevBtn.disabled = true;
        nextBtn.disabled = true;

        startOcrLoop(2000); // 2ç§’ã”ã¨ã« OCR
      }).catch(function(e) {
        console.error(e);
        alert("ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n" + e.name + " / " + e.message);
      });
    }

    function stopCamera() {
      if (mediaStream) {
        mediaStream.getTracks().forEach(function(t) { t.stop(); });
      }
      videoEl.srcObject = null;
      mediaStream = null;
      cameraOn = false;
      toggleCameraBtn.textContent = "ã‚«ãƒ¡ãƒ©ã‚’ã‚ªãƒ³ã«ã™ã‚‹";
      toggleCameraBtn.classList.remove("danger");
      ocrLog.innerHTML = "çŠ¶æ…‹ï¼šã‚«ãƒ¡ãƒ©ã¯ã‚ªãƒ•ã§ã™";

      prevBtn.disabled = false;
      nextBtn.disabled = false;

      if (ocrTimer) {
        clearInterval(ocrTimer);
        ocrTimer = null;
      }
    }

    toggleCameraBtn.addEventListener("click", function() {
      if (cameraOn) stopCamera();
      else startCamera();
    });

    function startOcrLoop(intervalMs) {
      if (ocrTimer) clearInterval(ocrTimer);
      ocrTimer = setInterval(runOcrOnce, intervalMs);
    }

    function runOcrOnce() {
      if (!cameraOn || !mediaStream) return;
      if (!pdfDoc) return;
      if (ocrRunning) return;
      ocrRunning = true;

      var vw = videoEl.videoWidth;
      var vh = videoEl.videoHeight;
      if (!vw || !vh) {
        ocrLog.innerHTML = "çŠ¶æ…‹ï¼šã‚«ãƒ¡ãƒ©æ˜ åƒã®æº–å‚™ä¸­â€¦";
        ocrRunning = false;
        return;
      }

      // ç”»é¢ä¸­å¤® 50% ã‚’åˆ‡ã‚Šå‡ºã—
      var cropW = vw * 0.5;
      var cropH = vh * 0.5;
      var cropX = (vw - cropW) / 2;
      var cropY = (vh - cropH) / 2;

      var targetWidth = 480;
      var scale = targetWidth / cropW;
      var targetHeight = Math.round(cropH * scale);

      captureCanvas.width = targetWidth;
      captureCanvas.height = targetHeight;

      captureCtx.drawImage(
        videoEl,
        cropX, cropY, cropW, cropH,
        0, 0, targetWidth, targetHeight
      );

      var dataUrl = captureCanvas.toDataURL("image/jpeg", 0.8);
      ocrLog.innerHTML = "çŠ¶æ…‹ï¼šæ•°å­—ã‚’èªè­˜ä¸­â€¦";

      Tesseract.recognize(dataUrl, "eng", {
        tessedit_char_whitelist: "0123456789"
      }).then(function(result) {
        var raw = (result.data && result.data.text) ? result.data.text : "";
        var compact = raw.replace(/\s+/g, "");
        ocrLog.innerHTML = "OCR ç”Ÿãƒ†ã‚­ã‚¹ãƒˆ: ã€Œ" + (raw || "ï¼ˆç©ºï¼‰ã€") +
                           "<br>ç©ºç™½é™¤å»: ã€Œ" + (compact || "ï¼ˆç©ºï¼‰ã€") + "<br>";

        var match = compact.match(/\d{1,4}/);
        if (!match) {
          ocrLog.innerHTML += "æ•°å­—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã£ã¨å¤§ããä¸­å¤®ã«æ›¸ã„ã¦ãã ã•ã„ã€‚";
          ocrRunning = false;
          return;
        }

        var page = parseInt(match[0], 10);
        ocrLog.innerHTML += "å€™è£œãƒšãƒ¼ã‚¸ç•ªå·: " + page + "<br>";

        if (!page || page <= 0) {
          ocrLog.innerHTML += "â†’ ãƒšãƒ¼ã‚¸ç•ªå·ã¨ã—ã¦ä¸æ­£ã§ã™ã€‚";
          ocrRunning = false;
          return;
        }
        if (page > totalPages) {
          ocrLog.innerHTML += "â†’ PDF ã¯ " + totalPages + " ãƒšãƒ¼ã‚¸ã¾ã§ãªã®ã§ç¯„å›²å¤–ã§ã™ã€‚";
          ocrRunning = false;
          return;
        }
        if (page === currentPage) {
          ocrLog.innerHTML += "â†’ ã™ã§ã«ãã®ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤ºä¸­ã§ã™ã€‚";
          ocrRunning = false;
          return;
        }

        if (lastPageByOcr === page) {
          ocrLog.innerHTML += "â†’ åŒã˜æ•°å­—ã‚’é€£ç¶šã§æ¤œå‡ºã—ãŸãŸã‚ã€ãƒšãƒ¼ã‚¸ " + page + " ã«ç§»å‹•ã—ã¾ã™ã€‚";
          jumpToPage(page);
          lastPageByOcr = null;
        } else {
          ocrLog.innerHTML += "â†’ åˆå›èªè­˜ã€‚ã‚‚ã†ä¸€åº¦åŒã˜æ•°å­—ãŒæ¤œå‡ºã•ã‚ŒãŸã‚‰ãƒšãƒ¼ã‚¸ã‚’ã‚ãã‚Šã¾ã™ã€‚";
          lastPageByOcr = page;
        }

        ocrRunning = false;
      }).catch(function(err) {
        console.error(err);
        ocrLog.innerHTML = "OCR ã‚¨ãƒ©ãƒ¼: " + err.message;
        ocrRunning = false;
      });
    }
  </script>
</body>
</html>
