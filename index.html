<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>QRã‚³ãƒ¼ãƒ‰é€£å‹• PDFãƒ“ãƒ¥ãƒ¼ã‚¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

  <!-- jsQRï¼ˆQRã‚³ãƒ¼ãƒ‰è§£æï¼‰-->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui;
      background: #f5f5f5;
      padding: 10px;
      color: #222;
    }
    h1 {
      text-align: center;
      font-size: 1.2rem;
      margin-bottom: 8px;
    }
    .top-bar {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-bottom: 8px;
    }
    .section {
      background: #fff;
      padding: 10px;
      margin-bottom: 14px;
      border-radius: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    .section h2 {
      font-size: 0.95rem;
      margin-bottom: 6px;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
      align-items: center;
    }
    #pdf-canvas {
      width: 100%;
      background: #888;
      border-radius: 8px;
      display: block;
    }
    #video {
      width: 100%;
      border-radius: 8px;
      background: #000;
      display: block;
    }
    button {
      padding: 6px 14px;
      border-radius: 999px;
      border: none;
      font-size: 0.9rem;
      cursor: pointer;
    }
    button.primary { background: #007bff; color: #fff; }
    button.danger  { background: #d9534f; color: #fff; }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    input[type="text"] {
      flex: 1;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }
    #pdf-info, #qr-log {
      font-size: 0.85rem;
      color: #555;
      margin-top: 4px;
      min-height: 1.2em;
    }

    /* ===== èª­æ›¸ãƒ¢ãƒ¼ãƒ‰ï¼ˆæ“¬ä¼¼ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ï¼‰ ===== */
    body.reading-mode {
      padding: 0;
      background: #ffffff;   /* â¬… èƒŒæ™¯ã‚’ç™½ã«æˆ»ã™ */
      color: #222;
    }
    body.reading-mode h1,
    body.reading-mode .pdf-load-controls {
      display: none;
    }
    body.reading-mode .pdf-section {
      margin: 0;
      border-radius: 0;
      box-shadow: none;
      min-height: 100vh;
    }
    body.reading-mode #pdf-canvas {
      border-radius: 0;
      display: block;
      margin: 0 auto;
    }

    /* åº•éƒ¨ç¿»é¡µæ¡ï¼šé€æ˜èƒŒæ™¯ï¼Œå°½é‡ä¸æŠ¢ç”»é¢ */
    body.reading-mode .page-controls-row {
      position: fixed;
      bottom: 8px;
      left: 0;
      right: 0;
      justify-content: center;
      z-index: 20;
      background: transparent;  /* â¬… ä¸å†é“ºå¤§é»‘æ¡ */
      padding: 0;
    }

    /* å…¨å±æ—¶çš„å°æ‘„åƒå¤´çª—å£ï¼šè´´åº•ä¸­é—´ï¼Œé¢ç§¯å¾ˆå° */
    body.reading-mode .camera-section {
      position: fixed;
      bottom: 44px;        /* åœ¨ç¿»é¡µæŒ‰é’®ä¸Šæ–¹ä¸€ç‚¹ */
      left: 50%;
      transform: translateX(-50%);
      width: 120px;
      z-index: 30;
      padding: 4px;
      margin: 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4);
      background: rgba(0,0,0,0.85);
      border-radius: 10px;
    }
    body.reading-mode .camera-section h2 {
      display: none;
    }
    body.reading-mode #video {
      border-radius: 6px;
    }
    body.reading-mode #qr-log {
      font-size: 0.7rem;
      color: #ddd;
    }
    body.reading-mode .top-bar {
      position: fixed;
      top: 6px;
      right: 6px;
      z-index: 40;
    }

    /* å°æ‘„åƒå¤´å›¾æ ‡ï¼ˆæŠ˜ã‚ŠãŸãŸã‚“ã çŠ¶æ…‹ï¼‰ */
    #camera-mini-icon {
      position: fixed;
      bottom: 44px;
      left: 50%;
      transform: translateX(-50%);
      width: 32px;
      height: 32px;
      background: rgba(0,0,0,0.75);
      color: #fff;
      border-radius: 999px;
      display: none;
      justify-content: center;
      align-items: center;
      font-size: 20px;
      z-index: 35;
      cursor: pointer;
    }

    /* å…¨å±æ—¶ï¼Œæ‘„åƒå¤´å¼€/å…³æŒ‰é’®è·Ÿç€åœ¨å³ä¸‹å°ä½ç½® */
    body.reading-mode #toggle-camera {
      position: fixed;
      bottom: 44px;
      left: 50%;
      transform: translateX(60px); /* å›¾æ ‡å³è¾¹ä¸€ç‚¹ç‚¹ */
      z-index: 36;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
    }
  </style>
</head>
<body>
  <h1>ğŸ“˜ QRã‚³ãƒ¼ãƒ‰é€£å‹• PDFãƒ“ãƒ¥ãƒ¼ã‚¢</h1>

  <div class="top-bar">
    <button id="reading-mode-btn" class="primary" disabled>èª­æ›¸ãƒ¢ãƒ¼ãƒ‰ã«ã™ã‚‹</button>
  </div>

  <!-- PDF ãƒ­ãƒ¼ãƒ‰ + è¡¨ç¤º -->
  <div class="section pdf-section">
    <div class="pdf-load-controls">
      <h2>â‘  PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€</h2>
      <div class="row">
        <input type="file" id="file-input" accept="application/pdf" />
      </div>
      <div class="row">
        <input id="url-input" type="text" placeholder="PDFã®URLï¼ˆhttps://...pdfï¼‰" />
        <button class="primary" id="load-url-btn">URLèª­è¾¼</button>
      </div>
      <div id="pdf-info">PDFæœªèª­è¾¼</div>
    </div>

    <canvas id="pdf-canvas"></canvas>

    <div class="row page-controls-row" style="margin-top:8px; display:none;">
      <button id="prev-btn">å‰ã¸</button>
      <div id="page-num" style="min-width:90px;text-align:center;">0 / 0</div>
      <button id="next-btn">æ¬¡ã¸</button>
    </div>
  </div>

  <!-- QR ã‚«ãƒ¡ãƒ© -->
  <div class="section camera-section">
    <h2>â‘¡ QRã‚³ãƒ¼ãƒ‰ã§ãƒšãƒ¼ã‚¸ç§»å‹•</h2>
    <div class="row">
      <button id="toggle-camera" class="primary" disabled>ã‚«ãƒ¡ãƒ©èµ·å‹•</button>
    </div>
    <video id="video" autoplay playsinline muted></video>
    <canvas id="qr-canvas" style="display:none;"></canvas>
    <div id="qr-log">çŠ¶æ…‹ï¼šã‚«ãƒ¡ãƒ©åœæ­¢ä¸­</div>
  </div>

  <!-- æŠ˜ã‚ŠãŸãŸã¿æ™‚ã®å°ã•ãªã‚«ãƒ¡ãƒ©ã‚¢ã‚¤ã‚³ãƒ³ -->
  <div id="camera-mini-icon">ğŸ“·</div>

  <script>
    /* ========== PDF.js è¨­å®š ========== */
    var pdfjsLib = window["pdfjsLib"];
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

    var pdfDoc = null;
    var currentPage = 1;
    var totalPages = 0;
    var pdfLoaded = false;

    var pdfCanvas = document.getElementById("pdf-canvas");
    var pdfCtx = pdfCanvas.getContext("2d");
    var pdfInfoEl = document.getElementById("pdf-info");
    var pageNumEl = document.getElementById("page-num");
    var pageControlsRow = document.querySelector(".page-controls-row");

    var readingModeBtn = document.getElementById("reading-mode-btn");
    var toggleCameraBtn = document.getElementById("toggle-camera");

    var cameraSection = document.querySelector(".camera-section");
    var cameraMiniIcon = document.getElementById("camera-mini-icon");
    var cameraCollapsed = false;

    function updatePageIndicator() {
      var text = currentPage + " / " + totalPages;
      pageNumEl.textContent = text;
    }

    function renderPage(num) {
      if (!pdfDoc) return;
      pdfDoc.getPage(num).then(function(page) {
        var viewport = page.getViewport({ scale: 1.4 });
        pdfCanvas.width = viewport.width;
        pdfCanvas.height = viewport.height;
        var renderCtx = { canvasContext: pdfCtx, viewport: viewport };
        page.render(renderCtx).promise.then(function() {
          currentPage = num;
          updatePageIndicator();
        });
      }).catch(function(err) {
        console.error("Render page error:", err);
      });
    }

    function updatePageControlsVisibility() {
      if (!pdfLoaded || !pdfDoc) {
        pageControlsRow.style.display = "none";
        return;
      }
      var inReading = document.body.classList.contains("reading-mode");
      if (inReading && cameraOn) {
        pageControlsRow.style.display = "none";
      } else {
        pageControlsRow.style.display = "flex";
      }
    }

    function updateCameraUi() {
      var inReading = document.body.classList.contains("reading-mode");
      if (!inReading) {
        cameraSection.style.display = "block";
        cameraMiniIcon.style.display = "none";
        return;
      }
      if (!cameraOn) {
        cameraCollapsed = false;
        cameraSection.style.display = "none";
        cameraMiniIcon.style.display = "none";
      } else {
        if (cameraCollapsed) {
          cameraSection.style.display = "none";
          cameraMiniIcon.style.display = "flex";
        } else {
          cameraSection.style.display = "block";
          cameraMiniIcon.style.display = "none";
        }
      }
    }

    function onPdfLoaded(label) {
      pdfLoaded = true;
      totalPages = pdfDoc.numPages;
      currentPage = 1;
      pdfInfoEl.textContent = label + " | " + totalPages + "ãƒšãƒ¼ã‚¸";

      pageControlsRow.style.display = "flex";

      readingModeBtn.disabled = false;
      toggleCameraBtn.disabled = false;

      startCamera();
      renderPage(1);
      updatePageControlsVisibility();
      updateCameraUi();
    }

    function loadPdfFromFile(file) {
      var reader = new FileReader();
      reader.onload = function(ev) {
        var data = ev.target.result;
        var task = pdfjsLib.getDocument({ data: data });
        task.promise.then(function(doc) {
          pdfDoc = doc;
          onPdfLoaded(file.name);
        }).catch(function(e) {
          console.error(e);
          alert("PDFã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        });
      };
      reader.readAsArrayBuffer(file);
    }

    function loadPdfFromUrl(url) {
      if (!url) {
        alert("PDFã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      var task = pdfjsLib.getDocument({ url: url });
      task.promise.then(function(doc) {
        pdfDoc = doc;
        onPdfLoaded(url);
      }).catch(function(e) {
        console.error(e);
        alert("URLã‹ã‚‰PDFã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚CORSåˆ¶é™ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
      });
    }

    document.getElementById("file-input").addEventListener("change", function(e) {
      var file = e.target.files[0];
      if (file) loadPdfFromFile(file);
    });

    document.getElementById("load-url-btn").addEventListener("click", function() {
      var url = document.getElementById("url-input").value.trim();
      loadPdfFromUrl(url);
    });

    document.getElementById("prev-btn").addEventListener("click", function() {
      if (!pdfDoc) return;
      if (currentPage > 1) renderPage(currentPage - 1);
    });

    document.getElementById("next-btn").addEventListener("click", function() {
      if (!pdfDoc) return;
      if (currentPage < totalPages) renderPage(currentPage + 1);
    });

    /* èª­æ›¸ãƒ¢ãƒ¼ãƒ‰ */
    var isReadingMode = false;

    function enterReadingMode() {
      document.body.classList.add("reading-mode");
      readingModeBtn.textContent = "èª­æ›¸ãƒ¢ãƒ¼ãƒ‰ã‚’è§£é™¤";
      updatePageControlsVisibility();
      updateCameraUi();
    }

    function exitReadingMode() {
      document.body.classList.remove("reading-mode");
      readingModeBtn.textContent = "èª­æ›¸ãƒ¢ãƒ¼ãƒ‰ã«ã™ã‚‹";
      updatePageControlsVisibility();
      updateCameraUi();
    }

    readingModeBtn.addEventListener("click", function() {
      if (!pdfLoaded) return;
      isReadingMode = !isReadingMode;
      if (isReadingMode) {
        enterReadingMode();
      } else {
        exitReadingMode();
      }
    });

    /* QR ã‚«ãƒ¡ãƒ© & jsQR */
    var cameraOn = false;
    var stream = null;

    var video = document.getElementById("video");
    var qrCanvas = document.getElementById("qr-canvas");
    var qrCtx = qrCanvas.getContext("2d");
    var qrLog = document.getElementById("qr-log");

    var lastScanData = "";
    var lastScanTime = 0;

    function startCamera() {
      if (cameraOn) return;
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã‚«ãƒ¡ãƒ©ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
        return;
      }
      if (!pdfLoaded || !pdfDoc) return;

      navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" },
        audio: false
      }).then(function(s) {
        stream = s;
        video.srcObject = stream;
        cameraOn = true;
        toggleCameraBtn.textContent = "ã‚«ãƒ¡ãƒ©åœæ­¢";
        toggleCameraBtn.classList.add("danger");
        qrLog.textContent = "çŠ¶æ…‹ï¼šã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­ï¼ˆQRã‚³ãƒ¼ãƒ‰ã‚’ã‹ã–ã—ã¦ãã ã•ã„ï¼‰";

        updatePageControlsVisibility();
        updateCameraUi();
        scanLoop();
      }).catch(function(e) {
        console.error(e);
        alert("ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      });
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(function(t) { t.stop(); });
      }
      stream = null;
      cameraOn = false;
      video.srcObject = null;
      toggleCameraBtn.textContent = "ã‚«ãƒ¡ãƒ©èµ·å‹•";
      toggleCameraBtn.classList.remove("danger");
      qrLog.textContent = "çŠ¶æ…‹ï¼šã‚«ãƒ¡ãƒ©åœæ­¢ä¸­";

      cameraCollapsed = false;
      updatePageControlsVisibility();
      updateCameraUi();
    }

    toggleCameraBtn.addEventListener("click", function(e) {
      if (!pdfLoaded) return;
      if (cameraOn) stopCamera();
      else startCamera();
      e.stopPropagation();
    });

    cameraSection.addEventListener("click", function(e) {
      var inReading = document.body.classList.contains("reading-mode");
      if (!inReading || !cameraOn) return;
      if (e.target.id === "toggle-camera") return;
      cameraCollapsed = true;
      updateCameraUi();
    });

    cameraMiniIcon.addEventListener("click", function() {
      if (!cameraOn) return;
      cameraCollapsed = false;
      updateCameraUi();
    });

    function scanLoop() {
      if (!cameraOn) return;

      var vw = video.videoWidth;
      var vh = video.videoHeight;
      if (!vw || !vh) {
        requestAnimationFrame(scanLoop);
        return;
      }

      qrCanvas.width = vw;
      qrCanvas.height = vh;
      qrCtx.drawImage(video, 0, 0, vw, vh);
      var imgData = qrCtx.getImageData(0, 0, vw, vh);

      var code = jsQR(imgData.data, vw, vh);
      if (code && code.data) {
        var now = Date.now();
        var dataStr = String(code.data);

        if (dataStr !== lastScanData || now - lastScanTime > 1500) {
          lastScanData = dataStr;
          lastScanTime = now;

          qrLog.textContent = "QRæ¤œå‡ºï¼š" + dataStr;

          var pageNum = parseInt(dataStr, 10);
          if (!isNaN(pageNum) && pageNum >= 1 && pageNum <= totalPages) {
            if (pageNum === currentPage) {
              qrLog.textContent = "QRæ¤œå‡ºï¼š" + dataStr + "ï¼ˆåŒã˜ãƒšãƒ¼ã‚¸ã®ãŸã‚ä½•ã‚‚ã—ã¾ã›ã‚“ï¼‰";
            } else {
              renderPage(pageNum);
            }
          } else {
            qrLog.textContent = "QRæ¤œå‡ºï¼š" + dataStr + "ï¼ˆæœ‰åŠ¹ãªãƒšãƒ¼ã‚¸ç•ªå·ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰";
          }
        }
      }

      requestAnimationFrame(scanLoop);
    }
  </script>
</body>
</html>
