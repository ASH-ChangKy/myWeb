<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>æ‘„åƒå¤´è¯†åˆ«é¡µç  PDF é˜…è¯»å™¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

  <!-- Tesseract.jsï¼ˆæœ¬åœ° OCRï¼‰ -->
  <script src="https://unpkg.com/tesseract.js@5.0.2/dist/tesseract.min.js"></script>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui,
        sans-serif;
      background: #f4f4f4;
      color: #222;
      padding: 10px;
    }
    h1 {
      font-size: 1.2rem;
      text-align: center;
      margin-bottom: 10px;
    }
    .section {
      background: #fff;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 10px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.07);
    }
    .section-title {
      font-size: 0.95rem;
      margin-bottom: 6px;
      font-weight: 600;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    label {
      font-size: 0.85rem;
    }
    input[type="file"],
    input[type="text"] {
      font-size: 0.85rem;
    }
    input[type="text"] {
      flex: 1;
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 0.85rem;
      cursor: pointer;
      white-space: nowrap;
    }
    button.primary {
      background: #007bff;
      color: #fff;
    }
    button.danger {
      background: #dc3545;
      color: #fff;
    }
    button.success {
      background: #28a745;
      color: #fff;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    #pdf-info {
      font-size: 0.8rem;
      margin-top: 4px;
    }
    #pdf-container {
      background: #333;
      border-radius: 8px;
      overflow: hidden;
      margin-top: 6px;
      text-align: center;
    }
    canvas#pdf-canvas {
      width: 100%;
      height: auto;
      display: block;
      background: #777;
    }
    #page-controls {
      margin-top: 6px;
      display: flex;
      justify-content: center;
      gap: 10px;
      font-size: 0.85rem;
      align-items: center;
      flex-wrap: wrap;
    }
    #page-indicator {
      min-width: 80px;
      text-align: center;
    }
    #camera-view {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      background: #000;
      max-height: 260px;
    }
    #video {
      width: 100%;
      height: auto;
      display: block;
    }
    #ocr-log {
      font-size: 0.8rem;
      margin-top: 4px;
      min-height: 1.2em;
    }
    #ocr-log span {
      display: inline-block;
      margin-right: 6px;
    }
    .hint {
      font-size: 0.75rem;
      color: #666;
      margin-top: 4px;
      line-height: 1.4;
    }
  </style>
</head>
<body>
  <h1>ğŸ“˜ æ‘„åƒå¤´è¯†åˆ«é¡µç  PDF é˜…è¯»å™¨ï¼ˆçº¯å‰ç«¯ç‰ˆï¼‰</h1>

  <!-- PDF é€‰æ‹© / åŠ è½½ -->
  <div class="section">
    <div class="section-title">1ï¸âƒ£ é€‰æ‹©æˆ–åŠ è½½ PDF</div>
    <div class="row" style="margin-bottom:6px;">
      <label>
        <input type="file" id="file-input" accept="application/pdf" />
      </label>
      <span style="font-size:0.8rem;color:#888;">â† é€‰æœ¬åœ° PDF æ–‡ä»¶</span>
    </div>
    <div class="row">
      <input
        type="text"
        id="url-input"
        placeholder="æˆ–è¾“å…¥åœ¨çº¿ PDF åœ°å€ï¼ˆhttps://...pdfï¼‰"
      />
      <button class="primary" id="load-url-btn">åŠ è½½ URL</button>
    </div>
    <div id="pdf-info">å°šæœªåŠ è½½ PDF</div>

    <div id="pdf-container">
      <canvas id="pdf-canvas"></canvas>
    </div>

    <div id="page-controls">
      <button id="prev-page-btn">ä¸Šä¸€é¡µ</button>
      <div id="page-indicator">ç¬¬ 0 / 0 é¡µ</div>
      <button id="next-page-btn">ä¸‹ä¸€é¡µ</button>
      <span style="font-size:0.8rem;">æ‰‹åŠ¨ç¿»é¡µä»…åœ¨æ‘„åƒå¤´å…³é—­æ—¶å¯ç”¨</span>
    </div>
  </div>

  <!-- æ‘„åƒå¤´ + OCR -->
  <div class="section">
    <div class="section-title">2ï¸âƒ£ ç”¨æ‘„åƒå¤´è¯†åˆ«çº¸ä¸Šçš„é¡µç </div>
    <div class="row" style="margin-bottom:6px;">
      <button class="primary" id="toggle-camera-btn">å¼€å¯æ‘„åƒå¤´</button>
      <button class="success" id="capture-btn" disabled>ğŸ“¸ æ‹ç…§å¹¶è¯†åˆ«é¡µç </button>
    </div>
    <div id="camera-view">
      <video id="video" autoplay playsinline muted></video>
    </div>
    <div id="ocr-log">
      <span>çŠ¶æ€ï¼šæ‘„åƒå¤´æœªå¼€å¯</span>
    </div>
    <div class="hint">
      ä½¿ç”¨æ–¹æ³•ï¼š
      <br />1. åœ¨çº¸ä¸Šå†™ä¸€ä¸ªå¾ˆå¤§çš„æ•°å­—ï¼ˆå¦‚ 12ã€145ã€233ï¼‰
      <br />2. ç”¨æ‰‹æœºæ¨ªç€/ç«–ç€éƒ½è¡Œï¼Œå¯¹å‡†æ•°å­—æ‹ç…§
      <br />3. ç½‘é¡µä¼šè¯†åˆ«æ•°å­—å¹¶è‡ªåŠ¨è·³åˆ°å¯¹åº” PDF é¡µ
      <br />4. æ‘„åƒå¤´å¼€å¯æ—¶ï¼Œæ‰‹åŠ¨ç¿»é¡µæŒ‰é’®ä¼šè¢«ç¦ç”¨
    </div>
  </div>

  <!-- éšè—ç”»å¸ƒï¼Œç”¨äºæˆªå›¾ç»™ OCR ç”¨ -->
  <canvas id="capture-canvas" style="display:none;"></canvas>

  <script>
    // ========= PDF.js åŸºæœ¬è®¾ç½® =========
    const pdfjsLib = window['pdfjsLib']; // 2.x ä¼šåœ¨ window ä¸ŠæŒ‚ pdfjsLib
    pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

    let pdfDoc = null;
    let currentPage = 1;
    let totalPages = 0;

    const pdfCanvas = document.getElementById('pdf-canvas');
    const pdfCtx = pdfCanvas.getContext('2d');
    const pdfInfoEl = document.getElementById('pdf-info');
    const pageIndicatorEl = document.getElementById('page-indicator');
    const prevBtn = document.getElementById('prev-page-btn');
    const nextBtn = document.getElementById('next-page-btn');

    function updatePageIndicator() {
      pageIndicatorEl.textContent = `ç¬¬ ${totalPages ? currentPage : 0} / ${
        totalPages || 0
      } é¡µ`;
    }

    async function renderPage(pageNum) {
      if (!pdfDoc) return;
      try {
        const page = await pdfDoc.getPage(pageNum);

        const viewport = page.getViewport({ scale: 1.4 });
        pdfCanvas.width = viewport.width;
        pdfCanvas.height = viewport.height;

        const renderContext = {
          canvasContext: pdfCtx,
          viewport,
        };
        await page.render(renderContext).promise;
        currentPage = pageNum;
        updatePageIndicator();
      } catch (err) {
        console.error('Render page error:', err);
      }
    }

    function jumpToPage(pageNum) {
      if (!pdfDoc) return;
      const n = parseInt(pageNum, 10);
      if (!Number.isInteger(n) || n < 1 || n > totalPages) {
        alert('è¯†åˆ«åˆ°çš„é¡µç è¶…å‡ºèŒƒå›´');
        return;
      }
      renderPage(n);
    }

    async function loadPdfFromData(data, label) {
      try {
        const loadingTask = pdfjsLib.getDocument({ data });
        pdfDoc = await loadingTask.promise;
        totalPages = pdfDoc.numPages;
        currentPage = 1;
        pdfInfoEl.textContent = `${label} | å…± ${totalPages} é¡µ`;
        await renderPage(currentPage);
      } catch (e) {
        console.error(e);
        alert('PDF åŠ è½½å¤±è´¥ï¼Œè¯·ç¡®è®¤æ–‡ä»¶æˆ–é“¾æ¥æ˜¯å¦æ­£ç¡®');
      }
    }

    async function loadPdfFromUrl(url) {
      try {
        const loadingTask = pdfjsLib.getDocument({ url });
        pdfDoc = await loadingTask.promise;
        totalPages = pdfDoc.numPages;
        currentPage = 1;
        pdfInfoEl.textContent = `${url} | å…± ${totalPages} é¡µ`;
        await renderPage(currentPage);
      } catch (e) {
        console.error(e);
        alert('URL PDF åŠ è½½å¤±è´¥ï¼Œè¯·ç¡®è®¤é“¾æ¥å¯ç›´æ¥è®¿é—® PDF');
      }
    }

    // æœ¬åœ°æ–‡ä»¶é€‰æ‹©
    document
      .getElementById('file-input')
      .addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (ev) {
          const arrayBuffer = ev.target.result;
          loadPdfFromData(arrayBuffer, file.name);
        };
        reader.readAsArrayBuffer(file);
      });

    // URL åŠ è½½
    document
      .getElementById('load-url-btn')
      .addEventListener('click', function () {
        const url = document.getElementById('url-input').value.trim();
        if (!url) {
          alert('è¯·è¾“å…¥ PDF çš„ URL åœ°å€');
          return;
        }
        loadPdfFromUrl(url);
      });

    // ========= æ‘„åƒå¤´æ§åˆ¶ =========
    const videoEl = document.getElementById('video');
    const captureCanvas = document.getElementById('capture-canvas');
    const captureCtx = captureCanvas.getContext('2d');
    const toggleCameraBtn = document.getElementById('toggle-camera-btn');
    const captureBtn = document.getElementById('capture-btn');
    const ocrLog = document.getElementById('ocr-log');

    let cameraOn = false;
    let mediaStream = null;
    let ocrRunning = false;

    function setManualPageButtonsEnabled(enabled) {
      prevBtn.disabled = !enabled;
      nextBtn.disabled = !enabled;
    }

    async function startCamera() {
      if (cameraOn) return;
      try {
        mediaStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment' },
          audio: false,
        });
        videoEl.srcObject = mediaStream;
        cameraOn = true;
        toggleCameraBtn.textContent = 'å…³é—­æ‘„åƒå¤´';
        toggleCameraBtn.classList.add('danger');
        captureBtn.disabled = false;
        ocrLog.innerHTML = '<span>çŠ¶æ€ï¼šæ‘„åƒå¤´å·²å¼€å¯</span>';
        setManualPageButtonsEnabled(false); // å¼€æ‘„åƒå¤´æ—¶ç¦ç”¨æ‰‹åŠ¨ç¿»é¡µ
      } catch (e) {
        console.error(e);
        alert('æ— æ³•å¼€å¯æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™');
      }
    }

    function stopCamera() {
      if (mediaStream) {
        mediaStream.getTracks().forEach((t) => t.stop());
      }
      videoEl.srcObject = null;
      mediaStream = null;
      cameraOn = false;
      toggleCameraBtn.textContent = 'å¼€å¯æ‘„åƒå¤´';
      toggleCameraBtn.classList.remove('danger');
      captureBtn.disabled = true;
      ocrLog.innerHTML = '<span>çŠ¶æ€ï¼šæ‘„åƒå¤´æœªå¼€å¯</span>';
      setManualPageButtonsEnabled(true); // å…³æ‘„åƒå¤´ï¼Œå…è®¸æ‰‹åŠ¨ç¿»é¡µ
    }

    toggleCameraBtn.addEventListener('click', function () {
      if (cameraOn) stopCamera();
      else startCamera();
    });

    prevBtn.addEventListener('click', function () {
      if (cameraOn) {
        alert('è¯·å…ˆå…³é—­æ‘„åƒå¤´å†æ‰‹åŠ¨ç¿»é¡µ');
        return;
      }
      if (!pdfDoc) return;
      if (currentPage <= 1) return;
      renderPage(currentPage - 1);
    });

    nextBtn.addEventListener('click', function () {
      if (cameraOn) {
        alert('è¯·å…ˆå…³é—­æ‘„åƒå¤´å†æ‰‹åŠ¨ç¿»é¡µ');
        return;
      }
      if (!pdfDoc) return;
      if (currentPage >= totalPages) return;
      renderPage(currentPage + 1);
    });

    // ========= OCR æµç¨‹ =========
    async function doOcrOnCurrentFrame() {
      if (!cameraOn || !mediaStream) {
        alert('è¯·å…ˆå¼€å¯æ‘„åƒå¤´');
        return;
      }
      if (!pdfDoc) {
        alert('è¯·å…ˆåŠ è½½ PDF');
        return;
      }
      if (ocrRunning) return;
      ocrRunning = true;
      captureBtn.disabled = true;

      try {
        // æŠ“ä¸€å¸§åˆ°éšè— canvas
        const videoWidth = videoEl.videoWidth;
        const videoHeight = videoEl.videoHeight;
        if (!videoWidth || !videoHeight) {
          alert('æ‘„åƒå¤´ç”»é¢å°šæœªå‡†å¤‡å¥½ï¼Œè¯·ç¨åå†è¯•');
          return;
        }
        // é€‚å½“ç¼©å°å°ºå¯¸ï¼ŒåŠ å¿« OCR
        const targetWidth = 640;
        const scale = targetWidth / videoWidth;
        const targetHeight = Math.round(videoHeight * scale);

        captureCanvas.width = targetWidth;
        captureCanvas.height = targetHeight;
        captureCtx.drawImage(videoEl, 0, 0, targetWidth, targetHeight);

        const dataUrl = captureCanvas.toDataURL('image/jpeg', 0.8);

        ocrLog.innerHTML =
          '<span>çŠ¶æ€ï¼šè¯†åˆ«ä¸­ï¼Œè¯·ç¨ç­‰â€¦â€¦</span>';

        // ä½¿ç”¨ Tesseract.js è¯†åˆ«ï¼ˆä»…æ•°å­—ï¼‰
        const result = await Tesseract.recognize(dataUrl, 'eng', {
          tessedit_char_whitelist: '0123456789',
        });

        const rawText = (result.data && result.data.text) || '';
        const normalized = rawText.replace(/\s+/g, '');
        const match = normalized.match(/\d{1,4}/); // æ‰¾ 1~4 ä½æ•°å­—

        ocrLog.innerHTML =
          '<span>åŸå§‹è¯†åˆ«ç»“æœï¼š' +
          (rawText || '(ç©º)') +
          '</span><br/><span>è¿‡æ»¤åï¼š' +
          (match ? match[0] : 'æœªæ‰¾åˆ°æ•°å­—') +
          '</span>';

        if (!match) {
          alert('æœªèƒ½è¯†åˆ«å‡ºæ•°å­—ï¼Œè¯·å†™æ›´å¤§ã€æ›´æ¸…æ™°ä¸€ç‚¹å†è¯•');
          return;
        }

        const pageNum = parseInt(match[0], 10);
        if (!Number.isInteger(pageNum) || pageNum <= 0) {
          alert('è¯†åˆ«å‡ºçš„é¡µç æ— æ•ˆ');
          return;
        }

        if (totalPages && pageNum > totalPages) {
          alert(
            'è¯†åˆ«åˆ°é¡µç  ' +
              pageNum +
              'ï¼Œä½† PDF åªæœ‰ ' +
              totalPages +
              ' é¡µ'
          );
          return;
        }

        jumpToPage(pageNum);
      } catch (e) {
        console.error(e);
        alert('è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•');
      } finally {
        ocrRunning = false;
        captureBtn.disabled = !cameraOn;
      }
    }

    captureBtn.addEventListener('click', doOcrOnCurrentFrame);
  </script>
</body>
</html>
