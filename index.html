<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å®æ—¶æ‘„åƒå¤´è¯†åˆ«é¡µç  PDF é˜…è¯»å™¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PDF.js 2.16.105 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

  <!-- Tesseract.jsï¼ˆæœ¬åœ° OCRï¼‰ -->
  <script src="https://unpkg.com/tesseract.js@5.0.2/dist/tesseract.min.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui;
      background: #f4f4f4;
      color: #222;
      padding: 10px;
    }
    h1 { text-align: center; font-size: 1.2rem; margin-bottom: 10px; }

    .section {
      background: #fff;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    .section-title { font-size: 0.95rem; margin-bottom: 6px; font-weight: 600; }

    #pdf-container { background:#333;border-radius:8px;overflow:hidden;margin-top:6px;text-align:center; }
    canvas#pdf-canvas { width:100%;background:#777; }

    #page-controls {
      margin-top: 6px; display:flex; justify-content:center; gap:10px;
      font-size:0.85rem; flex-wrap:wrap;
    }

    #camera-view { position:relative; background:#000; border-radius:8px; overflow:hidden; max-height:300px; }
    #video { width:100%; display:block; }

    #ocr-log { font-size:0.8rem; margin-top:6px; min-height:1.2em; }

    button {
      border:none; border-radius:999px; padding:6px 12px;
      font-size:0.85rem; cursor:pointer; white-space:nowrap;
    }
    button.primary { background:#007bff; color:#fff; }
    button.danger  { background:#dc3545; color:#fff; }
  </style>
</head>

<body>
<h1>ğŸ“˜ å®æ—¶æ‘„åƒå¤´è¯†åˆ«é¡µç  â†’ PDF è‡ªåŠ¨ç¿»é¡µ</h1>

<!-- ========== PDF è½½å…¥æ¨¡å— ========== -->
<div class="section">
  <div class="section-title">1ï¸âƒ£ åŠ è½½ PDF</div>

  <input type="file" id="file-input" accept="application/pdf" />
  <br/><br/>
  <input id="url-input" placeholder="æˆ–è¾“å…¥åœ¨çº¿ PDF åœ°å€" style="width:70%;padding:6px;border:1px solid #ccc;border-radius:6px;" />
  <button class="primary" id="load-url-btn">åŠ è½½ URL</button>

  <div id="pdf-info" style="margin-top:6px;font-size:0.8rem;">å°šæœªåŠ è½½ PDF</div>
  <div id="pdf-container"><canvas id="pdf-canvas"></canvas></div>

  <div id="page-controls">
    <button id="prev-page-btn">ä¸Šä¸€é¡µ</button>
    <span id="page-indicator">ç¬¬ 0 / 0 é¡µ</span>
    <button id="next-page-btn">ä¸‹ä¸€é¡µ</button>
  </div>
</div>

<!-- ========== æ‘„åƒå¤´å®æ—¶ OCR æ¨¡å— ========== -->
<div class="section">
  <div class="section-title">2ï¸âƒ£ å®æ—¶è¯†åˆ«çº¸é¢é¡µç ï¼ˆè‡ªåŠ¨ç¿»é¡µï¼‰</div>

  <button class="primary" id="toggle-camera-btn">å¼€å¯æ‘„åƒå¤´</button>

  <div id="camera-view">
    <video id="video" autoplay playsinline muted></video>
  </div>

  <div id="ocr-log">çŠ¶æ€ï¼šæ‘„åƒå¤´æœªå¼€å¯</div>
</div>

<!-- éšè— canvasï¼Œç”¨äº OCR æˆªå›¾ -->
<canvas id="capture-canvas" style="display:none;"></canvas>

<script>
/* ======= PDF.js åˆå§‹åŒ– ======= */
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
pdfjsLib.disableWorker = true;

let pdfDoc = null;
let currentPage = 1;
let totalPages = 0;

const pdfCanvas = document.getElementById("pdf-canvas");
const pdfCtx = pdfCanvas.getContext("2d");
const pageIndicatorEl = document.getElementById("page-indicator");
const prevBtn = document.getElementById("prev-page-btn");
const nextBtn = document.getElementById("next-page-btn");

function updatePageIndicator() {
  pageIndicatorEl.textContent = `ç¬¬ ${totalPages ? currentPage : 0} / ${totalPages || 0} é¡µ`;
}

async function renderPage(num) {
  if (!pdfDoc) return;
  const page = await pdfDoc.getPage(num);

  const viewport = page.getViewport({ scale: 1.4 });
  pdfCanvas.width = viewport.width;
  pdfCanvas.height = viewport.height;

  await page.render({ canvasContext: pdfCtx, viewport }).promise;
  currentPage = num;
  updatePageIndicator();
}

function jumpToPage(num) {
  if (!pdfDoc) return;
  if (num < 1 || num > totalPages) return;
  renderPage(num);
}

/* ======= PDF åŠ è½½ ======= */
document.getElementById("file-input").addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => loadPdfFromData(ev.target.result, file.name);
  reader.readAsArrayBuffer(file);
});

document.getElementById("load-url-btn").addEventListener("click", () => {
  loadPdfFromUrl(document.getElementById("url-input").value.trim());
});

async function loadPdfFromData(data, label) {
  const loadingTask = pdfjsLib.getDocument({ data });
  pdfDoc = await loadingTask.promise;

  totalPages = pdfDoc.numPages;
  currentPage = 1;
  document.getElementById("pdf-info").textContent = `${label} | å…± ${totalPages} é¡µ`;
  renderPage(1);
}

async function loadPdfFromUrl(url) {
  const loadingTask = pdfjsLib.getDocument({ url });
  pdfDoc = await loadingTask.promise;

  totalPages = pdfDoc.numPages;
  currentPage = 1;
  document.getElementById("pdf-info").textContent = `${url} | å…± ${totalPages} é¡µ`;
  renderPage(1);
}

/* æ‰‹åŠ¨ç¿»é¡µï¼ˆæ‘„åƒå¤´å¼€å¯æ—¶ç¦ç”¨ï¼‰ */
prevBtn.onclick = () => { if (!cameraOn && currentPage > 1) renderPage(currentPage - 1); };
nextBtn.onclick = () => { if (!cameraOn && currentPage < totalPages) renderPage(currentPage + 1); };

/* ======= æ‘„åƒå¤´å®æ—¶ OCR ======= */
let cameraOn = false;
let mediaStream = null;
const videoEl = document.getElementById("video");
const captureCanvas = document.getElementById("capture-canvas");
const captureCtx = captureCanvas.getContext("2d");
const toggleCameraBtn = document.getElementById("toggle-camera-btn");
const ocrLog = document.getElementById("ocr-log");

let ocrTimer = null;       // å®šæ—¶å™¨ï¼šå®šæœŸåš OCR
let lastPageByOcr = null;  // ä¸Šä¸€æ¬¡è¯†åˆ«åˆ°çš„é¡µç ï¼ˆç”¨äºé˜²æŠ–ï¼‰

async function startCamera() {
  if (cameraOn) return;

  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    alert("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´");
    return;
  }

  try {
    mediaStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: "environment" } }, // åç½®æ‘„åƒå¤´ä¼˜å…ˆ
      audio: false,
    });
    videoEl.srcObject = mediaStream;
    cameraOn = true;
    toggleCameraBtn.textContent = "å…³é—­æ‘„åƒå¤´";
    toggleCameraBtn.classList.add("danger");
    ocrLog.textContent = "çŠ¶æ€ï¼šæ‘„åƒå¤´å·²å¼€å¯ï¼Œæ­£åœ¨ç­‰å¾…è¯†åˆ«â€¦";

    // æ‘„åƒå¤´å¼€å¯æ—¶ï¼Œä¸å…è®¸æ‰‹åŠ¨ç¿»é¡µ
    prevBtn.disabled = true;
    nextBtn.disabled = true;

    // å¼€å§‹å®šæ—¶ OCRï¼ˆä¾‹å¦‚æ¯ 1500ms è¯†åˆ«ä¸€æ¬¡ï¼‰
    startOcrLoop(1500);
  } catch (e) {
    console.error(e);
    alert("æ— æ³•å¼€å¯æ‘„åƒå¤´ï¼š" + e.name + " / " + e.message + "\nè¯·æ£€æŸ¥ Safari çš„ç›¸æœºæƒé™");
  }
}

function stopCamera() {
  if (mediaStream) {
    mediaStream.getTracks().forEach((t) => t.stop());
  }
  mediaStream = null;
  cameraOn = false;
  videoEl.srcObject = null;
  toggleCameraBtn.textContent = "å¼€å¯æ‘„åƒå¤´";
  toggleCameraBtn.classList.remove("danger");

  ocrLog.textContent = "çŠ¶æ€ï¼šæ‘„åƒå¤´æœªå¼€å¯";
  prevBtn.disabled = false;
  nextBtn.disabled = false;

  // åœæ­¢ OCR å®šæ—¶ä»»åŠ¡
  if (ocrTimer) {
    clearInterval(ocrTimer);
    ocrTimer = null;
  }
}

// æ‘„åƒå¤´å¼€å…³æŒ‰é’®
toggleCameraBtn.onclick = () => {
  if (cameraOn) stopCamera();
  else startCamera();
};

/* ======= å®æ—¶ OCR å¾ªç¯ ======= */
function startOcrLoop(intervalMs) {
  if (ocrTimer) {
    clearInterval(ocrTimer);
  }
  ocrTimer = setInterval(runOcrOnce, intervalMs);
}

async function runOcrOnce() {
  if (!cameraOn || !mediaStream) return;
  if (!pdfDoc) {
    ocrLog.textContent = "çŠ¶æ€ï¼šè¯·å…ˆåŠ è½½ PDF å†å¼€å§‹è¯†åˆ«";
    return;
  }

  // é¿å… Tesseract è¿˜åœ¨è·‘æ—¶åˆå¯åŠ¨ä¸€è½®
  if (runOcrOnce.running) return;
  runOcrOnce.running = true;

  try {
    const vw = videoEl.videoWidth;
    const vh = videoEl.videoHeight;
    if (!vw || !vh) {
      ocrLog.textContent = "çŠ¶æ€ï¼šæ‘„åƒå¤´ç”»é¢å‡†å¤‡ä¸­â€¦";
      return;
    }

    // æŠŠè§†é¢‘ç”»é¢ç¼©æ”¾åˆ°åˆé€‚å¤§å°
    const targetWidth = 480;
    const scale = targetWidth / vw;
    const targetHeight = Math.round(vh * scale);

    captureCanvas.width = targetWidth;
    captureCanvas.height = targetHeight;
    captureCtx.drawImage(videoEl, 0, 0, targetWidth, targetHeight);

    const dataUrl = captureCanvas.toDataURL("image/jpeg", 0.8);

    ocrLog.textContent = "çŠ¶æ€ï¼šè¯†åˆ«ä¸­â€¦";

    const result = await Tesseract.recognize(dataUrl, "eng", {
      tessedit_char_whitelist: "0123456789",
    });

    const rawText = (result.data && result.data.text) || "";
    const normalized = rawText.replace(/\s+/g, "");
    const match = normalized.match(/\d{1,4}/); // åŒ¹é… 1~4 ä½æ•°å­—

    if (!match) {
      ocrLog.textContent = "çŠ¶æ€ï¼šæœªè¯†åˆ«åˆ°æ•°å­—ï¼Œè¯·è®©çº¸ä¸Šçš„æ•°å­—æ›´å¤§ã€æ›´æ¸…æ™°";
      return;
    }

    const pageNum = parseInt(match[0], 10);
    if (!Number.isInteger(pageNum) || pageNum <= 0) {
      ocrLog.textContent = "çŠ¶æ€ï¼šè¯†åˆ«åˆ°çš„æ•°å­—æ— æ•ˆï¼š" + match[0];
      return;
    }

    if (totalPages && pageNum > totalPages) {
      ocrLog.textContent =
        "çŠ¶æ€ï¼šè¯†åˆ«åˆ°é¡µç  " + pageNum + "ï¼Œä½† PDF åªæœ‰ " + totalPages + " é¡µ";
      return;
    }

    // å¦‚æœè¯†åˆ«ç»“æœå’Œå½“å‰é¡µä¸€æ ·ï¼Œå°±ä¸ç¿»é¡µï¼Œé¿å…é—ªçƒ
    if (pageNum === currentPage) {
      ocrLog.textContent = "çŠ¶æ€ï¼šè¯†åˆ«é¡µç  " + pageNum + "ï¼ˆå·²åœ¨è¯¥é¡µï¼‰";
      return;
    }

    // ç®€å•é˜²æŠ–ï¼šè¯†åˆ«ç»“æœè¿ç»­ä¸¤æ¬¡ç›¸åŒæ‰çœŸæ­£ç¿»é¡µ
    if (lastPageByOcr === pageNum) {
      ocrLog.textContent = "çŠ¶æ€ï¼šç¡®è®¤é¡µç  " + pageNum + "ï¼Œæ­£åœ¨è·³è½¬ PDF é¡µé¢â€¦";
      jumpToPage(pageNum);
    } else {
      ocrLog.textContent = "çŠ¶æ€ï¼šé¦–æ¬¡è¯†åˆ«åˆ°é¡µç  " + pageNum + "ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡ç¡®è®¤â€¦";
      lastPageByOcr = pageNum;
    }

  } catch (e) {
    console.error(e);
    ocrLog.textContent = "çŠ¶æ€ï¼šè¯†åˆ«å¤±è´¥ï¼š" + e.message;
  } finally {
    runOcrOnce.running = false;
  }
}
</script>
</body>
</html>
