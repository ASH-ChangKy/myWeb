<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>QRã‚³ãƒ¼ãƒ‰ã§ãƒšãƒ¼ã‚¸åŒæœŸ PDFãƒªãƒ¼ãƒ€ãƒ¼</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

<!-- jsQR -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  background:#f4f4f4;color:#222;padding:10px;
}

h1{text-align:center;font-size:1.3rem;margin-bottom:12px;}

/* ------ PDFã‚³ãƒ³ãƒ†ãƒŠ ------ */
#pdf-container{
  background:#222;margin-top:8px;border-radius:8px;overflow:hidden;
}
#pdf-canvas{width:100%;background:#666;display:block;}

#page-info{font-size:0.85rem;margin-top:4px;}

/* ------ ä¸‹éƒ¨ã®ãƒšãƒ¼ã‚¸æ“ä½œãƒãƒ¼ ------ */
.page-controls-row{
  margin-top:8px;
  display:none; /* PDFèª­ã¿è¾¼ã¿å‰ã¯éè¡¨ç¤º */
  gap:10px;
}
.page-controls-row button{
  padding:6px 12px;border:none;border-radius:6px;background:#007bff;color:#fff;
}
#page-num{padding-top:6px;font-size:0.9rem;min-width:70px;text-align:center;}

/* å…¨ç”»é¢ãƒ¢ãƒ¼ãƒ‰ã®ä¸‹éƒ¨ãƒãƒ¼ã‚’è–„ã */
body.reading-mode .page-controls-row{
  position:fixed;bottom:0;left:0;right:0;
  height:48px;
  background:rgba(0,0,0,0.55);
  display:flex !important;
  justify-content:center;align-items:center;
  z-index:50;
}

/* ------ ãƒŸãƒ‹ã‚«ãƒ¡ãƒ©ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ ------ */
#mini-camera-wrapper{
  position:fixed;
  bottom:58px;
  left:50%;
  transform:translateX(-50%);
  width:140px;height:90px;
  background:#000;border-radius:8px;
  overflow:hidden;
  box-shadow:0 2px 8px rgba(0,0,0,0.4);
  z-index:60;
  display:none;
}
#mini-video{
  width:100%;height:100%;object-fit:cover;
}

/* æŠ˜ã‚Šç•³ã‚“ã å¾Œã®ã‚¢ã‚¤ã‚³ãƒ³ */
#camera-icon-badge{
  position:fixed;
  bottom:60px;
  left:50%;
  transform:translateX(-50%);
  width:42px;height:42px;
  background:rgba(0,0,0,0.7);
  color:white;font-size:22px;
  border-radius:999px;
  display:none;
  justify-content:center;align-items:center;
  z-index:60;
  cursor:pointer;
}

/* PDFæ“ä½œãƒœã‚¿ãƒ³ */
button.primary{background:#007bff;color:#fff;border:none;border-radius:6px;padding:6px 12px;}
button.danger{background:#c62828;color:#fff;border:none;border-radius:6px;padding:6px 12px;}

</style>
</head>
<body>

<h1>ğŸ“˜ QRã‚³ãƒ¼ãƒ‰åŒæœŸ PDFãƒªãƒ¼ãƒ€ãƒ¼</h1>

<!-- 1. PDFèª­ã¿è¾¼ã¿ -->
<div>
  <div style="margin-bottom:6px;">
    <input type="file" id="file-input" accept="application/pdf" />
    <span style="font-size:0.8rem;color:#777;">â† ãƒ­ãƒ¼ã‚«ãƒ«PDFã‚’é¸æŠ</span>
  </div>

  <div style="display:flex;gap:8px;">
    <input id="pdf-url" type="text" placeholder="ã¾ãŸã¯PDF URL" style="flex:1;padding:6px;border:1px solid #ccc;border-radius:6px;font-size:0.9rem;" />
    <button class="primary" id="load-url-btn">URLèª­è¾¼</button>
  </div>

  <div id="page-info">PDFæœªèª­è¾¼</div>

  <div id="pdf-container">
    <canvas id="pdf-canvas"></canvas>
  </div>

  <div class="page-controls-row">
    <button id="prev-btn">å‰ã¸</button>
    <div id="page-num">0 / 0</div>
    <button id="next-btn">æ¬¡ã¸</button>
  </div>
</div>

<!-- 2. å…¨ç”»é¢ãƒœã‚¿ãƒ³ -->
<button id="fullscreen-btn" class="primary" style="margin-top:10px;">ğŸ“– å…¨ç”»é¢è¡¨ç¤º</button>

<!-- 3. ã‚«ãƒ¡ãƒ©å°çª“ -->
<div id="mini-camera-wrapper">
  <video id="mini-video" autoplay playsinline muted></video>
</div>

<div id="camera-icon-badge">ğŸ“·</div>

<script>
/* ===========================
   PDF.js åŸºæœ¬è¨­å®š
=========================== */
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

let pdfDoc = null;
let currentPage = 1;
let totalPages = 0;

const pdfCanvas = document.getElementById("pdf-canvas");
const pdfCtx = pdfCanvas.getContext("2d");
const pageInfo = document.getElementById("page-info");
const pageNumEl = document.getElementById("page-num");
const pageControlsRow = document.querySelector(".page-controls-row");

/* ãƒšãƒ¼ã‚¸ç•ªå·æ›´æ–° */
function updatePageNum() {
  pageNumEl.textContent = `${currentPage} / ${totalPages}`;
}

/* ãƒšãƒ¼ã‚¸æç”» */
async function renderPage(n) {
  if (!pdfDoc) return;
  const page = await pdfDoc.getPage(n);
  const viewport = page.getViewport({ scale: 1.4 });

  pdfCanvas.width = viewport.width;
  pdfCanvas.height = viewport.height;

  await page.render({
    canvasContext: pdfCtx,
    viewport
  }).promise;

  currentPage = n;
  updatePageNum();
}

/* ãƒšãƒ¼ã‚¸ã‚¸ãƒ£ãƒ³ãƒ— */
function jumpToPage(n) {
  if (n < 1 || n > totalPages) return;
  if (n === currentPage) return; // åŒã˜ãƒšãƒ¼ã‚¸ãªã‚‰ä½•ã‚‚ã—ãªã„ï¼ˆãƒãƒ©ã¤ãé˜²æ­¢ï¼‰
  renderPage(n);
}

/* PDFèª­ã¿è¾¼ã¿å…±é€šå‡¦ç† */
function afterPdfLoaded(label){
  totalPages = pdfDoc.numPages;
  currentPage = 1;
  pageInfo.textContent = `${label} | ${totalPages}ãƒšãƒ¼ã‚¸`;
  pageControlsRow.style.display = "flex";
  renderPage(1);
}

/* ãƒ­ãƒ¼ã‚«ãƒ«PDFèª­ã¿è¾¼ã¿ */
document.getElementById("file-input").addEventListener("change", e=>{
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = ev=>{
    pdfjsLib.getDocument({data:ev.target.result}).promise.then(doc=>{
      pdfDoc = doc;
      afterPdfLoaded(file.name);
    });
  };
  reader.readAsArrayBuffer(file);
});

/* URL PDFèª­ã¿è¾¼ã¿ */
document.getElementById("load-url-btn").addEventListener("click",()=>{
  const url = document.getElementById("pdf-url").value.trim();
  if(!url){ alert("PDFã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

  pdfjsLib.getDocument({url}).promise.then(doc=>{
    pdfDoc = doc;
    afterPdfLoaded(url);
  });
});

/* å‰å¾Œãƒšãƒ¼ã‚¸ */
document.getElementById("prev-btn").addEventListener("click",()=>{
  jumpToPage(currentPage - 1);
});
document.getElementById("next-btn").addEventListener("click",()=>{
  jumpToPage(currentPage + 1);
});

/* ===========================
   å…¨ç”»é¢è¡¨ç¤º
=========================== */
const fsBtn = document.getElementById("fullscreen-btn");
fsBtn.addEventListener("click",()=>{
  document.body.classList.toggle("reading-mode");
});

/* ===========================
   ã‚«ãƒ¡ãƒ©ï¼ˆå°çª“ï¼‰
=========================== */
let cameraOn = false;
let stream = null;
let mini = document.getElementById("mini-camera-wrapper");
let icon = document.getElementById("camera-icon-badge");
let miniVideo = document.getElementById("mini-video");
let miniCollapsed = false;

/* ã‚«ãƒ¡ãƒ©èµ·å‹• */
async function startCamera(){
  if(cameraOn) return;
  try{
    stream = await navigator.mediaDevices.getUserMedia({
      video:{facingMode:"environment"}
    });
    miniVideo.srcObject = stream;
    cameraOn = true;

    mini.style.display = "block";
    icon.style.display = "none";
  }catch(e){
    alert("ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã§ãã¾ã›ã‚“ã€‚Safariã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
  }
}

/* ã‚«ãƒ¡ãƒ©åœæ­¢ */
function stopCamera(){
  if(stream) stream.getTracks().forEach(t=>t.stop());
  cameraOn = false;
  mini.style.display = "none";
  icon.style.display = "none";
}

/* ãƒŸãƒ‹ç”»é¢ã‚¯ãƒªãƒƒã‚¯ â†’ æŠ˜ã‚Šç•³ã¿ */
mini.addEventListener("click",()=>{
  if(!cameraOn) return;
  mini.style.display = "none";
  icon.style.display = "flex";
  miniCollapsed = true;
});

/* ã‚¢ã‚¤ã‚³ãƒ³ã‚¯ãƒªãƒƒã‚¯ â†’ å±•é–‹ */
icon.addEventListener("click",()=>{
  if(!cameraOn) startCamera();
  icon.style.display = "none";
  mini.style.display = "block";
  miniCollapsed = false;
});

/* ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å¾Œã™ãã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹ */
startCamera();

/* ===========================
   QRã‚³ãƒ¼ãƒ‰è§£æ
=========================== */
function scanLoop(){
  if(!cameraOn) return requestAnimationFrame(scanLoop);

  const vw = miniVideo.videoWidth;
  const vh = miniVideo.videoHeight;
  if(!vw || !vh) return requestAnimationFrame(scanLoop);

  const temp = document.createElement("canvas");
  temp.width = vw; temp.height = vh;
  const ctx = temp.getContext("2d");
  ctx.drawImage(miniVideo,0,0);

  const imgData = ctx.getImageData(0,0,vw,vh);
  const qr = jsQR(imgData.data, vw, vh);

  if(qr){
    const text = qr.data.trim();
    if(text.startsWith("PAGE:")){
      const num = parseInt(text.replace("PAGE:",""));
      jumpToPage(num);
    }
  }

  requestAnimationFrame(scanLoop);
}

scanLoop();

</script>
</body>
</html>
