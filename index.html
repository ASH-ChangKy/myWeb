<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>QRã‚³ãƒ¼ãƒ‰é€£å‹• PDFãƒ“ãƒ¥ãƒ¼ã‚¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <!-- jsQRï¼ˆQRã‚³ãƒ¼ãƒ‰è§£æï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui;
      background: #e3f7f5;          /* å†·è‰²æ·¡ç»¿è‰² */
      padding: 10px;
      color: #222;
    }

    h1 {
      text-align: center;
      font-size: 1.2rem;
      margin-bottom: 8px;
    }

    .top-bar {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-bottom: 8px;
    }

    .section {
      background: #ffffff;
      padding: 10px;
      margin-bottom: 14px;
      border-radius: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }

    .section h2 {
      font-size: 0.95rem;
      margin-bottom: 6px;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
      align-items: center;
    }

    #pdf-canvas {
      width: 100%;
      background: #fdfdfd;
      border-radius: 8px;
      display: block;
    }

    #video {
      width: 100%;
      border-radius: 8px;
      background: #000;
      display: block;
    }

    button {
      padding: 6px 14px;
      border-radius: 999px;
      border: none;
      font-size: 0.9rem;
      cursor: pointer;
    }

    button.primary { background: #007bff; color: #fff; }
    button.danger  { background: #d9534f; color: #fff; }
    button.secondary { background:#5a6268; color:#fff; }

    button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    input[type="text"] {
      flex: 1;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }

    #pdf-info, #qr-log {
      font-size: 0.85rem;
      color: #555;
      margin-top: 4px;
      min-height: 1.2em;
    }

    /* ========= èª­æ›¸ãƒ¢ãƒ¼ãƒ‰ï¼ˆæ“¬ä¼¼å…¨ç”»é¢ï¼‰ ========= */
    body.reading-mode {
      padding: 0;
      background: #e3f7f5;
      color: #111;
    }

    body.reading-mode h1,
    body.reading-mode .pdf-load-controls {
      display: none;
    }

    body.reading-mode .pdf-section {
      margin: 0;
      border-radius: 0;
      box-shadow: none;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;   /* PDFã‚’ç¸¦æ–¹å‘ã»ã¼ä¸­å¤®ã« */
      align-items: center;
      background: #e3f7f5;
    }

    body.reading-mode #pdf-canvas {
      border-radius: 0;
      max-height: 100vh;
    }

    /* ãƒšãƒ¼ã‚¸ç§»å‹•ãƒœã‚¿ãƒ³ï¼ˆèª­æ›¸ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯å›ºå®šï¼‰ */
    .page-controls-row {
      margin-top: 8px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
    }

    body.reading-mode .page-controls-row {
      position: fixed;
      bottom: 10px;
      left: 0;
      right: 0;
      justify-content: center;
      z-index: 20;
      pointer-events: auto;
    }

    /* ========= ã‚«ãƒ¡ãƒ©ã‚¨ãƒªã‚¢ ========= */
    .camera-section {
      position: relative;
    }

    .camera-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
    }

    .camera-mini-toggle {
      display: none;
      font-size: 1.4rem;
      text-align: center;
      cursor: pointer;
    }

    /* èª­æ›¸ãƒ¢ãƒ¼ãƒ‰æ™‚ï¼šã‚«ãƒ¡ãƒ©ã‚’ç”»é¢ä¸‹ä¸­å¤®ã®å°çª“ã«ã™ã‚‹ */
    body.reading-mode .camera-section {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 56px;              /* ãƒšãƒ¼ã‚¸ãƒœã‚¿ãƒ³ã‚ˆã‚Šå°‘ã—ä¸Š */
      width: 180px;
      margin: 0;
      background: rgba(0,0,0,0.82);
      color: #eee;
      box-shadow: 0 2px 8px rgba(0,0,0,0.6);
      border-radius: 10px;
      padding: 6px 8px;
      z-index: 30;
    }

    body.reading-mode .camera-section h2 {
      display: none;
    }

    body.reading-mode #video {
      border-radius: 6px;
      max-height: 100px;
    }

    body.reading-mode #qr-log {
      font-size: 0.7rem;
      color: #ddd;
    }

    body.reading-mode .top-bar {
      position: fixed;
      top: 6px;
      right: 6px;
      z-index: 40;
    }

    /* æŠ˜ã‚ŠãŸãŸã¿çŠ¶æ…‹ï¼šå‹•ç”»ã¨ãƒ­ã‚°ã‚’éš ã—ã¦ã€ã‚¢ã‚¤ã‚³ãƒ³ã ã‘å‡ºã™ */
    .camera-section.collapsed #video,
    .camera-section.collapsed #qr-log {
      display: none;
    }

    .camera-section.collapsed .camera-mini-toggle {
      display: block;
    }

    /* PCã§è¦‹ãŸã¨ãä¸Šé™ */
    @media (min-width: 768px) {
      body.reading-mode #pdf-canvas {
        max-width: 90vw;
      }
    }
  </style>
</head>
<body>
  <h1>ğŸ“˜ QRã‚³ãƒ¼ãƒ‰é€£å‹• PDFãƒ“ãƒ¥ãƒ¼ã‚¢</h1>

  <div class="top-bar">
    <button id="reading-mode-btn" class="primary">èª­æ›¸ãƒ¢ãƒ¼ãƒ‰ã«ã™ã‚‹</button>
  </div>

  <!-- PDF ãƒ­ãƒ¼ãƒ‰ + è¡¨ç¤º -->
  <div class="section pdf-section">
    <div class="pdf-load-controls">
      <h2>â‘  PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€</h2>
      <div class="row">
        <input type="file" id="file-input" accept="application/pdf" />
      </div>
      <div class="row">
        <input id="url-input" type="text" placeholder="PDFã®URLï¼ˆhttps://...pdfï¼‰" />
        <button class="primary" id="load-url-btn">URLèª­è¾¼</button>
      </div>
      <div id="pdf-info">PDFæœªèª­è¾¼</div>
    </div>

    <canvas id="pdf-canvas"></canvas>

    <div class="row page-controls-row" id="page-controls-row">
      <button id="prev-btn">å‰ã¸</button>
      <div id="page-num" style="min-width:90px;text-align:center;">0 / 0</div>
      <button id="next-btn">æ¬¡ã¸</button>
    </div>
  </div>

  <!-- QR ã‚«ãƒ¡ãƒ© -->
  <div class="section camera-section" id="camera-section">
    <h2>â‘¡ QRã‚³ãƒ¼ãƒ‰ã§ãƒšãƒ¼ã‚¸ç§»å‹•</h2>
    <div class="camera-header-row">
      <button id="collapse-camera-btn" class="secondary">ğŸ”’ æŠ˜ã‚ŠãŸãŸã¿</button>
      <button id="toggle-camera" class="primary">ã‚«ãƒ¡ãƒ©èµ·å‹•</button>
    </div>
    <div class="camera-mini-toggle" id="camera-mini-toggle">ğŸ“·</div>
    <video id="video" autoplay playsinline muted></video>
    <canvas id="qr-canvas" style="display:none;"></canvas>
    <div id="qr-log">çŠ¶æ…‹ï¼šã‚«ãƒ¡ãƒ©åœæ­¢ä¸­</div>
  </div>

  <script>
    /* ========== PDF.js è¨­å®š ========== */
    var pdfjsLib = window["pdfjsLib"];
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

    var pdfDoc = null;
    var currentPage = 1;
    var totalPages = 0;

    var pdfCanvas = document.getElementById("pdf-canvas");
    var pdfCtx = pdfCanvas.getContext("2d");
    var pdfInfoEl = document.getElementById("pdf-info");
    var pageNumEl = document.getElementById("page-num");
    var pageControlsRow = document.getElementById("page-controls-row");

    function updatePageIndicator() {
      var text = currentPage + " / " + totalPages;
      pageNumEl.textContent = text;
    }

    function updatePageControlsVisibility() {
      // PDF ãŒãªã„ã¨ãã¯ãƒœã‚¿ãƒ³ã‚’éš ã™
      if (!pdfDoc) {
        pageControlsRow.style.display = "none";
        return;
      }
      // èª­æ›¸ãƒ¢ãƒ¼ãƒ‰ ï¼‹ ã‚«ãƒ¡ãƒ©ON ã®ã¨ãã¯éš ã™
      if (isReadingMode && cameraOn) {
        pageControlsRow.style.display = "none";
      } else {
        pageControlsRow.style.display = "flex";
      }
    }

    function renderPage(num) {
      if (!pdfDoc) return;
      pdfDoc.getPage(num).then(function(page) {
        var viewport = page.getViewport({ scale: 1.4 });
        pdfCanvas.width = viewport.width;
        pdfCanvas.height = viewport.height;
        var renderCtx = { canvasContext: pdfCtx, viewport: viewport };
        page.render(renderCtx).promise.then(function() {
          currentPage = num;
          updatePageIndicator();
        });
      }).catch(function(err) {
        console.error("Render page error:", err);
      });
    }

    function loadPdfFromFile(file) {
      var reader = new FileReader();
      reader.onload = function(ev) {
        var data = ev.target.result;
        var task = pdfjsLib.getDocument({ data: data });
        task.promise.then(function(doc) {
          pdfDoc = doc;
          totalPages = pdfDoc.numPages;
          currentPage = 1;
          pdfInfoEl.textContent = file.name + " | " + totalPages + "ãƒšãƒ¼ã‚¸";
          renderPage(1);
          updatePageControlsVisibility();
        }).catch(function(e) {
          console.error(e);
          alert("PDFã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        });
      };
      reader.readAsArrayBuffer(file);
    }

    function loadPdfFromUrl(url) {
      if (!url) {
        alert("PDFã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      var task = pdfjsLib.getDocument({ url: url });
      task.promise.then(function(doc) {
        pdfDoc = doc;
        totalPages = pdfDoc.numPages;
        currentPage = 1;
        pdfInfoEl.textContent = url + " | " + totalPages + "ãƒšãƒ¼ã‚¸";
        renderPage(1);
        updatePageControlsVisibility();
      }).catch(function(e) {
        console.error(e);
        alert("URLã‹ã‚‰PDFã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚CORSåˆ¶é™ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
      });
    }

    document.getElementById("file-input").addEventListener("change", function(e) {
      var file = e.target.files[0];
      if (file) loadPdfFromFile(file);
    });

    document.getElementById("load-url-btn").addEventListener("click", function() {
      var url = document.getElementById("url-input").value.trim();
      loadPdfFromUrl(url);
    });

    document.getElementById("prev-btn").addEventListener("click", function() {
      if (!pdfDoc) return;
      if (currentPage > 1) renderPage(currentPage - 1);
    });

    document.getElementById("next-btn").addEventListener("click", function() {
      if (!pdfDoc) return;
      if (currentPage < totalPages) renderPage(currentPage + 1);
    });

    /* ========== èª­æ›¸ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ ========== */
    var readingModeBtn = document.getElementById("reading-mode-btn");
    var isReadingMode = false;

    function enterReadingMode() {
      document.body.classList.add("reading-mode");
      readingModeBtn.textContent = "èª­æ›¸ãƒ¢ãƒ¼ãƒ‰ã‚’è§£é™¤";
      updatePageControlsVisibility();
    }

    function exitReadingMode() {
      document.body.classList.remove("reading-mode");
      readingModeBtn.textContent = "èª­æ›¸ãƒ¢ãƒ¼ãƒ‰ã«ã™ã‚‹";
      updatePageControlsVisibility();
    }

    readingModeBtn.addEventListener("click", function() {
      isReadingMode = !isReadingMode;
      if (isReadingMode) {
        enterReadingMode();
      } else {
        exitReadingMode();
      }
    });

    /* ========== QR ã‚«ãƒ¡ãƒ© & jsQR ========== */
    var cameraOn = false;
    var stream = null;

    var video = document.getElementById("video");
    var qrCanvas = document.getElementById("qr-canvas");
    var qrCtx = qrCanvas.getContext("2d");
    var qrLog = document.getElementById("qr-log");
    var toggleCameraBtn = document.getElementById("toggle-camera");

    var cameraSection = document.getElementById("camera-section");
    var collapseBtn = document.getElementById("collapse-camera-btn");
    var cameraMiniToggle = document.getElementById("camera-mini-toggle");
    var isCameraCollapsed = false;

    var lastScanData = "";
    var lastScanTime = 0;

    function startCamera() {
      if (cameraOn) return;
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã‚«ãƒ¡ãƒ©ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
        return;
      }
      if (!pdfDoc) {
        alert("å…ˆã«PDFã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚");
        return;
      }

      navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" },
        audio: false
      }).then(function(s) {
        stream = s;
        video.srcObject = stream;
        cameraOn = true;
        toggleCameraBtn.textContent = "ã‚«ãƒ¡ãƒ©åœæ­¢";
        toggleCameraBtn.classList.add("danger");
        qrLog.textContent = "çŠ¶æ…‹ï¼šã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­ï¼ˆQRã‚³ãƒ¼ãƒ‰ã‚’ã‹ã–ã—ã¦ãã ã•ã„ï¼‰";
        updatePageControlsVisibility();
        scanLoop();
      }).catch(function(e) {
        console.error(e);
        alert("ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      });
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(function(t) { t.stop(); });
      }
      stream = null;
      cameraOn = false;
      video.srcObject = null;
      toggleCameraBtn.textContent = "ã‚«ãƒ¡ãƒ©èµ·å‹•";
      toggleCameraBtn.classList.remove("danger");
      qrLog.textContent = "çŠ¶æ…‹ï¼šã‚«ãƒ¡ãƒ©åœæ­¢ä¸­";
      updatePageControlsVisibility();
    }

    toggleCameraBtn.addEventListener("click", function() {
      if (cameraOn) stopCamera();
      else startCamera();
    });

    /* æŠ˜ã‚ŠãŸãŸã¿ï¼šå°ã•ãªã‚¢ã‚¤ã‚³ãƒ³ã ã‘ã«ã™ã‚‹ */
    collapseBtn.addEventListener("click", function() {
      isCameraCollapsed = !isCameraCollapsed;
      if (isCameraCollapsed) {
        cameraSection.classList.add("collapsed");
        collapseBtn.textContent = "ğŸ”“ å±•é–‹";
      } else {
        cameraSection.classList.remove("collapsed");
        collapseBtn.textContent = "ğŸ”’ æŠ˜ã‚ŠãŸãŸã¿";
      }
    });

    cameraMiniToggle.addEventListener("click", function() {
      // ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨å†å±•é–‹
      isCameraCollapsed = false;
      cameraSection.classList.remove("collapsed");
      collapseBtn.textContent = "ğŸ”’ æŠ˜ã‚ŠãŸãŸã¿";
    });

    function scanLoop() {
      if (!cameraOn) return;

      var vw = video.videoWidth;
      var vh = video.videoHeight;
      if (!vw || !vh) {
        requestAnimationFrame(scanLoop);
        return;
      }

      qrCanvas.width = vw;
      qrCanvas.height = vh;
      qrCtx.drawImage(video, 0, 0, vw, vh);
      var imgData = qrCtx.getImageData(0, 0, vw, vh);

      var code = jsQR(imgData.data, vw, vh);
      if (code && code.data) {
        var now = Date.now();
        var dataStr = String(code.data);

        // é˜²æŠ–ï¼šåŒã˜å†…å®¹ã‚’çŸ­æ™‚é–“ã«ä½•åº¦ã‚‚æ¤œå‡ºã—ãŸã‚‰ç„¡è¦–
        if (dataStr !== lastScanData || now - lastScanTime > 1500) {
          lastScanData = dataStr;
          lastScanTime = now;

          qrLog.textContent = "QRæ¤œå‡ºï¼š" + dataStr;

          var pageNum = parseInt(dataStr, 10);
          if (!isNaN(pageNum) && pageNum >= 1 && pageNum <= totalPages) {
            if (pageNum === currentPage) {
              qrLog.textContent = "QRæ¤œå‡ºï¼š" + dataStr + "ï¼ˆåŒã˜ãƒšãƒ¼ã‚¸ã®ãŸã‚ä½•ã‚‚ã—ã¾ã›ã‚“ï¼‰";
            } else {
              renderPage(pageNum);
            }
          } else {
            qrLog.textContent = "QRæ¤œå‡ºï¼š" + dataStr + "ï¼ˆæœ‰åŠ¹ãªãƒšãƒ¼ã‚¸ç•ªå·ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰";
          }
        }
      }

      requestAnimationFrame(scanLoop);
    }

    // åˆæœŸçŠ¶æ…‹ã§ã¯ãƒšãƒ¼ã‚¸ãƒœã‚¿ãƒ³ã‚’éš ã—ã¦ãŠã
    updatePageControlsVisibility();
  </script>
</body>
</html>
